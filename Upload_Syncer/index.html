<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Drive Upload Syncer</title>
  <style>
    #dropZone { border: 2px dashed #aaa; padding: 20px; margin-top: 10px; cursor: pointer; }
    #dropZone.dragover { background-color: #eee; }
    progress { width: 100%; margin-top: 10px; }
    select { display: block; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Upload Files to Drive</h1>
  <div id="folderDropdown"></div>
  <div id="dropZone">Drop files here or click to select</div>
  <input type="file" id="file" multiple style="margin-top: 10px;">
  <button onclick="uploadFiles()">Upload</button>
  <progress id="progressBar" value="0" max="100"></progress>
  <div id="status"></div>
</body>
<script>
let folderConfig = {};
let selectedFolderId = null;
google.script.run.withSuccessHandler(htmlContent => {
  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlContent, 'text/html');
  const jsonData = doc.getElementById('folderData').textContent;
  folderConfig = JSON.parse(jsonData);
  buildDropdown('folderDropdown', folderConfig);
}).getFolderConfigHtml();
function getNestedObj(obj, path) {
  return path.reduce((acc, key) => (acc && acc[key] ? acc[key] : null), obj);
}
function buildDropdown(containerId, obj, path=[]) {
  const container = document.getElementById(containerId);
  const select = document.createElement('select');
  select.innerHTML = '<option value="">--Select Folder--</option>';
  for (const key in obj) select.innerHTML += `<option value="${key}">${key}</option>`;
  container.appendChild(select);
  select.onchange = function() {
    const existing = Array.from(container.querySelectorAll('select'));
    const index = existing.indexOf(select);
    existing.slice(index+1).forEach(e => e.remove());
    const val = select.value;
    if (!val) { selectedFolderId = null; return; }
    const newPath = [...path, val];
    const nextObj = getNestedObj(folderConfig, newPath);
    if (typeof nextObj === 'string') {
      selectedFolderId = nextObj;
      console.log("Selected folder ID:", selectedFolderId);
    } else if (typeof nextObj === 'object') {
      buildDropdown(containerId, nextObj, newPath);
    }
  }
}
function uploadFiles(files=null) {
  const filesToUpload = files || document.getElementById('file').files;
  if (!selectedFolderId) { alert("Please select a folder!"); return; }
  if (!filesToUpload.length) { alert("Select at least one file!"); return; }
  const names = Array.from(filesToUpload).map(f => f.name).join('\n');
  if (!confirm("Upload these files?\n" + names)) return;
  const progress = document.getElementById('progressBar');
  let uploaded = 0;
  for (let f of filesToUpload) {
    const reader = new FileReader();
    reader.onload = function(e) {
      // Send the Base64-encoded string, file metadata, and MIME type to the server.
      google.script.run.withSuccessHandler(msg => {
        document.getElementById('status').innerHTML += `<p>${msg}</p>`;
        uploaded++;
        progress.value = (uploaded / filesToUpload.length) * 100;
      }).uploadFile(f.name, e.target.result, selectedFolderId, f.type);
    };
    reader.readAsDataURL(f);
  }
}
const dropZone = document.getElementById('dropZone');
dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
dropZone.ondragleave = (e) => { dropZone.classList.remove('dragover'); };
dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); uploadFiles(e.dataTransfer.files); };
dropZone.onclick = () => document.getElementById('file').click();
</script>
</html>